<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cluster {{ members["cluster_id"] }} – {{ infection }}</title>
    <script
      type="text/javascript"
      src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
    ></script>
    <style>
      body {
        font-family: sans-serif;
        max-width: 1000px;
        line-height: 1.4;
        margin: 1rem;
      }
      h1,
      h2,
      h3 {
        margin-top: 1em;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 0.5em;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 4px 8px;
        text-align: left;
      }
      ul {
        padding-left: 1.2em;
      }
      .meta span {
        display: inline-block;
        margin-right: 1em;
      }
      a:hover {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <h1>Cluster {{ members["cluster_id"] }} – Infection: {{ infection }}</h1>

    <section class="meta">
      <span><strong>Size:</strong> {{ members["size"] }}</span>
      <span
        ><strong>Timespan:</strong> {{ members["timespan_days"] }} days</span
      >
      <span
        ><strong>First positive:</strong> {{ members["first_positive"] }}</span
      >
      <span
        ><strong>Last positive:</strong> {{ members["last_positive"] }}</span
      >
    </section>

    <h2>Locations</h2>
    {% if members["locations"] %}
    <ul>
      {% for loc in members["locations"] %}
      <li>{{ loc }}</li>
      {% endfor %}
    </ul>
    {% else %}
    <p>No locations recorded.</p>
    {% endif %}

    <h2>Cluster Members</h2>
    {% if members["members"] %}
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Member (patient_id)</th>
        </tr>
      </thead>
      <tbody>
        {% for m in members["members"] %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ m }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>No member records.</p>
    {% endif %}

    <h2>Contact Edges</h2>
    <p>{{ members["contact_edges"] }} potential transmission links</p>

    <h2>Contact Events</h2>
    <p>{{ members["contact_events"] }} observed interactions</p>

    <h2>Contact Network</h2>
    <div
      id="network"
      style="
        border: 1px solid #ccc;
        width: 100%;
        height: 400px;
        margin-top: 1rem;
      "
    ></div>

    <p><a href="/clusters/">Back to all clusters</a></p>
    <script type="text/javascript">
        // Convert members into Vis.js nodes
        const nodes = new vis.DataSet(
          {{ members.members | tojson }}
            .map((id) => ({ id: id, label: id, title: id }))
        );

        // Edges: use edges_list with contact_events for tooltips
      const edges = new vis.DataSet(
        {{ members.edges_list | tojson }}
          .map(e => ({
            from: e.from,
            to: e.to,
            label: e.contact_events.toString(),
            title: `${e.contact_events} contact events`
          }))
      );

      const container = document.getElementById("network");
      const data = { nodes, edges };
      const options = {
        nodes: { shape: "dot", size: 17 },
        edges: { arrows: { enabled: false }, font: { align: "top" }, smooth: false },
        layout: { improvedLayout: true },
        physics: { stabilization: true }
      };
        const network = new vis.Network(container, data, options);
    </script>
  </body>
</html>
